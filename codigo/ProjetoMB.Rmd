---
title: "Modelação Bayesiana"
author: 
  - "Diogo Freitas"
  - "João Francisco Botas"
  - "Miguel Gonçalves"
  - "Ricardo Galvão"
date: "19-03-2025"
output: 
  html_document:
    df_print: paged
    code_folding: show
    self_contained: true
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Modelação Bayesiana

Este projeto foi desenvolvido no âmbito da unidade curricular de Modelação Bayesiana do Mestrado em Ciência de Dados no Iscte. O objetivo do trabalho tem como objetivo replicar 

## Índice

## Artigo de referência

O artigo de referência para este trabalho é o [Data on higher education student ethics model](https://www.sciencedirect.com/science/article/pii/S2352340919312594?via%3Dihub). Este artigo analisa dados de um questionário aplicado a estudantes de ensino superior para avaliar a ética dos mesmos. O questionário foi aplicado a 566 estudantes entre o período de Janeiro a Dezembro de 2018, na cidade de Yogyakarta, na Indonesia. Para percebermos melhor o conjunto de dados e a sua estrutura, vamos carregar o ficheiro de dados e fazer uma pequena analise exploratória de dados, complementando a informação com a descrição do artigo.


```{r, include=FALSE}
# packages
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(foreign, haven, tidyverse, rstan, blavaan, lavaan, 
               brms, psych, bayesplot)
```


## EDA

```{r}
# load data
df <- read.csv("../data/dados_raw.csv")
View(df)
df %>% glimpse()
```

Skim do dataset para vermos a estrutura detalhada dos dados.

```{r, results='hold'}
df %>% skimr::skim() -> skim_output
###########
# skim_output
# str(skim_output) # ver a estrutura para filtrar
###########
min(skim_output$complete_rate) # todas as colunas têm valores preenchidos
max(colSums(is.na(df))) 
```

Ao guardarmos o skim num objeto podemos ver a estrutura e filtrar as informações que queremos. Neste caso, conseguimos ver que todas as colunas:
- têm todos os valores preenchidos $\rightarrow$ mínimo do `complete_rate` é 1;
- não existem valores em falta, consequentemente $\rightarrow$ máximo do número de valores em falta é 0.

Ou seja, não teremos de lidar com omissos.

```{r}
# select character columns
skim_output$skim_variable[skim_output$skim_type == "character"] -> char_cols
char_cols
# select numeric columns
skim_output$skim_variable[skim_output$skim_type == "numeric"] -> num_cols
length(num_cols) # = 127 total - 1 (Fak)
```

### Variáveis categóricas

No dataset só temos uma variável categórica, a `Fak`. Vamos fazer uma tabela de frequências para esta variável e um gráfico de barras. Esta variável, segundo o artigo, é a _faculty_/departamento a que o estudante pertence (**Table 8** artigo).

| Departamento                    | Nº alunos | Percentagem |
|---------------------------------|-----------|-------------|
| Economic                        |        114|        20.1%|
| Engineering                     |         98|        17.3%|
| Mathematics and Natural Science |         85|        15.0%|
| Social Science                  |         61|        10.8%|
| Sports Science                  |         15|         2.7%|
| Art                             |        120|        21.2%|
| Educational Science             |         73|        12.9%|
   

```{r}
# fazer uma tabela de frequências para as variáveis categóricas
df %>% select(all_of(char_cols)) %>% map(table)
# gráfico de barras
df %>%
  group_by(Fak) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100) %>%
  ggplot(aes(x = reorder(Fak, -Percentage), y = Percentage)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(x = "Field", y = "Percentage", title = "Distribution of Fields") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Conseguimos perceber que há uma relação com os resultados mencionados no artigo.


| Departamento                    | Sigla     |
|---------------------------------|-----------|
| Economic                        |         FE| 
| Engineering                     |         FT| 
| Mathematics and Natural Science |       MIPA| 
| Social Science                  |        FIS| 
| Sports Science                  |        FIK|
| Art                             |        FBS| 
| Educational Science             |        FIP| 


A partir de agora vamos guardar os dados num novo dataset para podermos fazer a modelação.

```{r}
df_transform <- df
df_transform <- df_transform %>%
  mutate(Fak = case_when(
    Fak == "FE" ~ "Economic",
    Fak == "FT" ~ "Engineering",
    Fak == "MIPA" ~ "Mathematics and Natural Science",
    Fak == "FIS" ~ "Social Science",
    Fak == "FIK" ~ "Sports Science",
    Fak == "FBS" ~ "Art",
    Fak == "FIP" ~ "Educational Science",
    TRUE ~ Fak
  ))
summary(as.factor(df_transform$Fak)) # factor para mostrar a coluna alterada
```

### Variáveis numéricas citadas no artigo

O artigo menciona que o questionário tem 7 grupos de perguntas que medem dimensões diferentes. Cada grupo está associado a um nome que, por sua vez, tem uma sigla associada.

1. **Ethical behaviour** (ET)
2. **Motivation** (Mot)
3. **Self-efficacy** (SE)
4. **Resilience** (R)
5. **Knowledge articulation** (KA)
6. **Team strain** (TS)
7. **Cooperative classroom environment** (CCE)

Vamos selecionar as variáveis que pertencem a cada grupo e guardá-las em objetos diferentes. No final vamos juntar estas variáveis num novo dataset.

```{r}
# select das variáveis numéricas mencionadas no artigo -> regex para ser + facil :)
ethical_behaviour <- df_transform %>%
  select(matches("^ET[1-9]$|^ET1[0-4]$"))
#ethical_behaviour

motivation <- df_transform %>%
  select(matches("^Mot[1-9]$|^Mot1[0-5]$"))
#motivation

self_efficacy <- df_transform %>%
  select(matches("^SE[1-6]$"))
#self_efficacy

resilience <- df_transform %>%
  select(matches("^R[1-6]$"))
#resilience

knowledge_articulation <- df_transform %>%
  select(matches("^KA[1-5]$"))
#knowledge_articulation

team_strain <- df_transform %>%
  select(matches("^TS[1-9]$|^TS1[0-7]$"))
#team_strain

cooperative_classroom_environment <- df_transform %>%
  select(matches("^CCE[1-9]$|^CCE1[0-9]$|^CCE20$"))
#cooperative_classroom_environment

## falta 3xPOP; 6xPC; 6xOPT; 5xINO; 3xPDC

# juntar todos os dataframes com as colunas mencionadas no artigo (as acima)
vars_artigo <- bind_cols(ethical_behaviour, motivation, self_efficacy, 
                         resilience, knowledge_articulation, team_strain, 
                         cooperative_classroom_environment)
vars_artigo
```


**O que não consta no artigo: 3xPOP; 6xPC; 6xOPT; 5xINO; 3xPDC**

### Construtos criados no artigo

Ainda, temos acesso aos construtos criados pelos autores do artigo após a fase de análise fatorial. Vamos selecionar estas variáveis e guardá-las num objeto. Os construtos estão referidos na **Table 9** do artigo.

```{r}
construtos_autores <- df_transform[, 121:127]
construtos_autores
```

### Variáveis descritivas?

Guardamos agora 8 variáveis do início do dataset que parecem ser apenas descritivas e que são referidas (algumas destas) no artigo, na tabela com as correlações. As correlações entre construtos pode ser encontrada na **Table 10** do artigo.

Uma destas variáveis é a `Fak` que já foi tratada anteriormente. Esta será incluída juntamente com as outras 7 e já terá os nomes alterados.

```{r}
descritivas <- df_transform[, 1:8]
descritivas
```


```{r}
skimr::skim(descritivas)$skim_variable
skimr::skim(descritivas)$numeric.p0
skimr::skim(descritivas)$numeric.p100
```


Após alguma pesquisa fomos tentar verificar o que representavam estas variáveis. 


- **Género**:Género da pessoa (pode ser 1 ou 2). À partida não sabemos qual corresponde ao feminino e ao masculino.
- **Tlahir**: Em indonésio pode ser uma abreviatura de Tanggal Lahir, que significa data de nascimento.
- **BLhair**: Em indonésio pode ser uma abreviatura de Bulan Lahir, que significa mês de nascimento.
- *Pengeluaran**: Em indonésio pode ser uma abreviatura de Pengeluaran, que significa despesas. Tradução direta para inglês $rightarrow$ Expenditure.


Verificamos o mínimo e o máximo de cada variável descritiva e percebemos alguns valores estranhos, dado o contexto pesquisado. Um deles é por exemplo o `Tlahir`. Talvez o valor mais alto $\rightarrow 31031999$ corresponde a $31/03/1999$. Para além disso o mês `BLhair` tem valores de 0 a 12, pelo que o 0 não faz muito sentido. 

Estes valores não vão ser alterados, por enquanto, porque não serão importantes para a análise e replicação dos resultados.

### Variáveis não citadas no artigo

As colunas que não estão nos outros datasets.

```{r}
# selecionar do dataset df_transform aquelas que não estao em descritivas, vars_artigo e construtos_autores
vars_nao_citadas <- df_transform %>%
  select(-all_of(c(colnames(descritivas), colnames(vars_artigo), colnames(construtos_autores))))
vars_nao_citadas
```

### Criar ficheiros csv na pasta data com os 4 conjuntos anteriores

```{r}
# escrever uma função
write_csvs <- function(data, name){
  write_csv(data, paste0("../data/4_conjuntos(dev)/", name, ".csv"))
}
write_csvs(descritivas, "descritivas")
write_csvs(vars_artigo, "vars_artigo")
write_csvs(construtos_autores, "construtos_autores")
write_csvs(vars_nao_citadas, "vars_nao_citadas")
```


## Fase 2: Replicação do artigo

### 1 - CFA para cada conjunto de questões

```{r}
# ler csv 
df <- read_csv("../data/4_conjuntos(dev)/vars_artigo.csv")
df
```

Como primeira análise vamos fazer uma análise fatorial confirmatória (CFA) para tentar verificar se as variáveis utilizadas nos construtos são as que têm valores de loadings mais elevados. Vamos usar o pacote `blavaan` para fazer a modelação bayesiana.

```{r}
# individual params
n_chains <- 3
burn_in <- 1000
sample_estimate <- 5000
```


### CFA com todas as variáveis para tentar justificar/perceber as escolhas para os construtos

#### Student Ethics

```{r}
# Student Ethics
model.ethics <- 'StudentEthics =~ ET1 + ET2 + ET3 + ET4 + ET5 + ET6 + ET7 + 
                                  ET8 + ET9 + ET10 + ET11 + ET12 + ET13'
fit.ethics <- bcfa(model.ethics, data = df, std.lv = TRUE,
                      n.chains = n_chains, burnin=burn_in, 
                      sample=sample_estimate, target = "stan")
summary(fit.ethics, standardized = TRUE, rsquare = TRUE)
fitMeasures(fit.ethics)
```
1000 burn-in + 5000 samples

| Item  | Loadings  |
|-------|-----------|
| ET1   | 0.518     |
| ET2   | 0.445     |
| ET3   | 0.685     |
| ET4   | 0.430     |
| ET5   | 0.714     |
| ET6   | 0.582     |
| ET7   | -0.083    |
| ET8   | -0.036    |
| ET9   | -0.062    |
| ET10  | 0.157     |
| ET11  | 0.133     |
| ET12  | 0.331     |
| ET13  | 0.324     |

O artigo opta por selecionar apenas 2 variáveis para o `Student Ethics` (ET12 e ET13), que não têm os loadings mais expressantes. As variáveis ET1, ET3, ET5 e ET6 têm valores de loadings elevado, mas não são escolhidas. As variáveis ET7-9 têm um loading negativo, o que não faz sentido. 


```{r}
# Motivation
model.motivation <- 'Motivation =~ Mot1 + Mot2 + Mot3 + Mot4 + Mot5 + 
                                  Mot6 + Mot7 + Mot8 + Mot9 + Mot10 + 
                                  Mot11 + Mot12 + Mot13 + Mot14 + 
                                  Mot15'
fit.motivation <- bcfa(model.motivation, data = df, std.lv = TRUE,
                      n.chains = n_chains, burnin=burn_in, 
                      sample=sample_estimate, target = "stan")
summary(fit.motivation, standardized = TRUE, rsquare = TRUE)
fitMeasures(fit.motivation)
```

1000 burn-in + 5000 samples

| Item  | Loadings  |
|--------|----------|
| Mot1   | 0.363    |
| Mot2   | 0.386    |
| Mot3   | 0.244    |
| Mot4   | 0.367    |
| Mot5   | -0.079   |
| Mot6   | 0.410    |
| Mot7   | 0.259    |
| Mot8   | -0.102   |
| Mot9   | 0.354    |
| Mot10  | 0.317    |
| Mot11  | -0.059   |
| Mot12  | 0.285    |
| Mot13  | 0.422    |
| Mot14  | 0.354    |
| Mot15  | -0.166   |
 


```{r}
# Self-Efficacy
model.efficacy <- 'SelfEfficacy =~ SE1 + SE2 + SE3 + SE4 + SE5 + SE6'
fit.efficacy <- bcfa(model.efficacy, data = df, std.lv = TRUE,
                      n.chains = n_chains, burnin=burn_in, 
                      sample=sample_estimate, target = "stan")
summary(fit.efficacy, standardized = TRUE, rsquare = TRUE)
fitMeasures(fit.efficacy)
```


```{r}
# Resilience
model.resilience <- 'Resilience =~ R1 + R2 + R3 + R4 + R5 + R6'
fit.resilience <- bcfa(model.resilience, data = df, std.lv = TRUE,
                      n.chains = n_chains, burnin=burn_in, 
                      sample=sample_estimate, target = "stan")
summary(fit.resilience, standardized = TRUE, rsquare = TRUE)
fitMeasures(fit.resilience)
```


```{r}
# Knowledge Articulation
model.knowledge <- 'KnowledgeArticulation =~ KA1 + KA2 + KA3 + KA4 + KA5'
fit.knowledge <- bcfa(model.knowledge, data = df, std.lv = TRUE,
                      n.chains = n_chains, burnin=burn_in, 
                      sample=sample_estimate, target = "stan")
summary(fit.knowledge, standardized = TRUE, rsquare = TRUE)
fitMeasures(fit.knowledge)
```


```{r}
# Team Strain
model.teamstrain <- 'TeamStrain =~ TS1 + TS2 + TS3 + TS4 + TS5 + 
                                  TS6 + TS7 + TS8 + TS9 + TS10 + 
                                  TS11 + TS12 + TS13 + TS14 + 
                                  TS15 + TS16 + TS17'
fit.teamstrain <- bcfa(model.teamstrain, data = df, std.lv = TRUE,
                      n.chains = n_chains, burnin=burn_in, 
                      sample=sample_estimate, target = "stan")
summary(fit.teamstrain, standardized = TRUE, rsquare = TRUE)
fitMeasures(fit.teamstrain)
```


```{r}
# Cooperative Classroom Environment
model.cce <- 'CooperativeClassroomEnvironment =~ CCE1 + CCE2 + CCE3 + 
                                  CCE4 + CCE5 + CCE6 + CCE7 + CCE8 + 
                                  CCE9 + CCE10 + CCE11'
fit.cce <- bcfa(model.cce, data = df, std.lv = TRUE,
                      n.chains = n_chains, burnin=burn_in, 
                      sample=sample_estimate, target = "stan")
summary(fit.cce, standardized = TRUE, rsquare = TRUE)
fitMeasures(fit.cce)
```



### 2 - CFA Global

Vai ter as covariâncias entre fatores.


```{r}

```


### 3- SEM


```{r}
model.sem <- '
  # measurement model
  StudentEthics =~ ET12 + ET13
  Motivation =~ Mot5 + Mot8 + Mot11
  SelfEfficacy =~ SE1 + SE2 + SE3 + SE4 + SE5 + SE6
  Resilience =~ R2 + R5 + R6
  KnowledgeArticulation =~ KA1 + KA2 + KA3 + KA4 + KA5
  TeamStrain =~ TS10 + TS11 + TS12 + TS13 + TS14 + TS15 + TS16 + TS17
  CooperativeClassroomEnvironment =~ CCE1 + CCE3 + CCE4 + CCE5 + CCE8 + CCE9 + CCE10 + CCE11
  # regressions
  Motivation ~ Resilience + KnowledgeArticulation + TeamStrain + CooperativeClassroomEnvironment
  SelfEfficacy ~ Resilience + KnowledgeArticulation + TeamStrain + CooperativeClassroomEnvironment
  StudentEthics ~ Motivation + SelfEfficacy
  
'

fit.full <- bcfa(model.full, data=df, std.lv=TRUE, n.chains = 3,
                 burnin=200, sample=500, target = "stan")
```


```{r}
summary(fit.full, standardized=TRUE, rsquare=TRUE)
```







